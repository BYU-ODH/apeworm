<html>
<head>
<meta charset=utf-8 />
</head>
<body>
	<script src="pixi.dev.js"></script>
	<script src="vowelworm.js"></script>
	<script src="vowelworm.draw.js"></script>
        <script src="vowelworm.game.js"></script>
	<script src="wormGraph.js"></script>

  <audio style='display:none' controls id=media src="test/audio/vowels.wav"></audio>
  <video style='display:none' width=250 height=200 controls id=vid src="test/video/demo.mp4"></video>

  <button onclick=usemedia()>Use Audio File</button>
  <button onclick=usevideo()>Use Video File</button>
  <button onclick=usemic()>Use Microphone</button>

  <pre>
expected values, in kHz, for test/audio/vowels.wav

       f1       f2       f3
  i    0.25     2.25     3.05
  e    0.45     2.1      2.55
  a    0.55     1.1      2.6
  o    0.4      0.9      2.25
  u    0.3      0.8      2.25

Â±0.1 kHz
  </pre>
  <div id='graphs'></div>
  
  <form>
    <div>
      <label>maxDB: <input type='number' step=5 min=-400 max=0 id='maxDB'></label>
    </div>
    <div>
      <label>minDB: <input type='number' step=5 min=-400 max=0 id='minDB'></label>
    </div>
    <div>
      <label>HANNING_SHIFT: <input type='number' step=1 min=0 max=50 id='hs'></label>
    </div>
    <div>
      <label>Min MFCC Hz: <input type='number' step=500 min=0 max=5000 id='min_hz' value=300></label>
    </div>
    <div>
      <label>Max MFCC Hz: <input type='number' step=500 min=0 max=9000 id='max_hz' value=8000></label>
    </div>
    <div>
      <label>Number of MFCC Filter Banks: <input type='number' step=1 min=0 max=30 value=10 id='fb'></label>
    </div>
  </form>

  <script>
    var graphs = document.getElementById('graphs');

    // for the IPA representation
    var width = 700;
    var height = 500;
//x1 = xStart, x2 = xEnd and the same for y
    var x1=-1;
    var x2=2;
    var y1=-1;
    var y2=3;

    var minHz = 300;
    var maxHz = 8000;
    var fb = 10;

    var stage = new PIXI.Stage(0xFFFFFF);
    var renderer = PIXI.autoDetectRenderer(width+40, height+40);
    makeGraph(stage, renderer, width, height, x1, x2, y1, y2);

    graphs.appendChild(renderer.view);
    // end IPA code
                                                                              
    function getUserMedia() {
      (navigator.getUserMedia || navigator.webkitGetUserMedia || function(){alert('getUserMedia missing')})
                            .apply(navigator, arguments);
    }

    var worm = new VowelWorm.instance();
    var audio = document.getElementById('media');
    audio.loop = true;
    var video = document.getElementById('vid');
    video.loop = true;

    function drawit() {
      var canvas = worm.draw.create(window.outerWidth-width-100, height);
      worm.draw.drawAxes();

      graphs.appendChild(canvas);
    }

    function run() {
      worm.game.play(worm);

//      var position = worm.getMFCCs({
//          minFreq: minHz,
//          maxFreq: maxHz,
//          filterBanks: fb
//      });
//      if(position.length) {
//        x = position[1];
//        y = position[2];
//
//        // rotate 90 degrees
//        var tmpY = y;
//        var tmpX = x;
//        x = tmpY;
//        y = -tmpX;
//
//        makeWorm(x,y, stage, renderer, width, height, x1, x2, y1, y2);
//      }
//      worm.draw.drawDataLines();
//      window.requestAnimationFrame(run);
    };

    function usemedia() {
      audio.style.display = 'block';
      worm.setStream(audio);
      drawit();
      run();
    };
    
    function usevideo() {
      video.style.display = 'block';
      worm.setStream(video);
      drawit();
      run();
    };

    function micSuccess(stream) {
      makeGraph(stage, renderer, width, height);

      worm.setStream(stream);
      drawit();
      run(worm);
    };

    function micFailure() {
      alert("Could not capture microphone input");
    };

    function usemic() {
      audio.pause();
      audio.style.display = 'none';
      getUserMedia({audio: true}, micSuccess, micFailure);
    };

    (function(){

     var maxDB = document.getElementById('maxDB'),
         minDB = document.getElementById('minDB');

     var hanningShift = document.getElementById('hs');

     var minHz_el = document.getElementById('min_hz');
     var maxHz_el = document.getElementById('max_hz');
     var fb_el = document.getElementById('fb');

     var timeout = null;

     var redraw =  function(){
       worm.draw.maxDecibels = parseInt(maxDB.value, 10);
       worm.draw.minDecibels = parseInt(minDB.value, 10);
       if(timeout) { cancelAnimationFrame(timeout); }
       
       timeout = requestAnimationFrame(function(){
         cancelAnimationFrame(timeout);
         worm.draw.drawAxes();
       });
     };

     maxDB.value = worm.draw.maxDecibels;
     minDB.value = worm.draw.minDecibels;
     hanningShift.value = VowelWorm.HANNING_SHIFT;

     maxDB.addEventListener('change', redraw);
     minDB.addEventListener('change', redraw);

     hs.addEventListener('change', function() {
       VowelWorm.HANNING_SHIFT = hs.value;
     });

     minHz_el.addEventListener('change', function() {
        minHz = parseFloat(minHz_el.value);
     });
     maxHz_el.addEventListener('change', function() {
        maxHz = parseFloat(maxHz_el.value);
     });
     fb_el.addEventListener('change', function() {
         fb = parseInt(fb_el.value,10);
     });
    })();
  </script>
</body>
</html>
