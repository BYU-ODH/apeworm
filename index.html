<html>
<head></head>
<body>
	<script src="pixi.dev.js"></script>
	<script src="vowelworm.js"></script>
	<script src="vowelworm.draw.js"></script>
	<script src="wormGraph.js"></script>
  <audio style='display:none' controls id=media src="avowellong.wav"></audio>

  <button onclick=usemedia()>Use Media File</button>
  <button onclick=usemic()>Use Microphone</button>

  <div id='graphs'></div>
  
  <form>
    <div>
      <label>maxFormantHz: <input type='number' step=100 min=1000 max=44100 id='maxFormantHz'></label>
    </div>
  </form>

  <script>
    var graphs = document.getElementById('graphs');

    // for the IPA representation
    var width = 200;
    var height = 200;
//x1 = xStart, x2 = xEnd and the same for y
    var x1=200;
    var x2=1000;
    var y1=3000;
    var y2=500;

    var stage = new PIXI.Stage(0xFFFFFF);
    var renderer = PIXI.autoDetectRenderer(width+40, height+40);
    makeGraph(stage, renderer, width, height, x1, x2, y1, y2);

    graphs.appendChild(renderer.view);
    // end IPA code
                                                                              
    function getUserMedia() {
      (navigator.getUserMedia || navigator.webkitGetUserMedia || function(){alert('getUserMedia missing')})
                            .apply(navigator, arguments);
    }

    var worm = new VowelWorm.instance();
    worm.maxFormantHz = 10000;
    var audio = document.getElementById('media');
    audio.loop = true;

    function drawit() {
      var canvas = worm.draw.create(window.outerWidth-width-100, height);
      worm.draw.drawAxes();

      graphs.appendChild(canvas);
    }

    function run() {
      //var position = worm.normalize(worm.getFormants());
      var position = worm.getFormants();
      if(position.length) {
        makeWorm(position[0],position[1], stage, renderer, width, height, x1, x2, y1, y2);
      }
      worm.draw.drawDataLines();
      window.requestAnimationFrame(run);
    };

    function usemedia() {
      audio.style.display = 'block';
      worm.setStream(audio);
      drawit();
      run();
    };

    function micSuccess(stream) {
      makeGraph(stage, renderer, width, height);

      worm.setStream(stream);
      drawit();
      run(worm);
    };

    function micFailure() {
      alert("Could not capture microphone input");
    };

    function usemic() {
      audio.pause();
      audio.style.display = 'none';
      getUserMedia({audio: true}, micSuccess, micFailure);
    };

    (function(){
     var mfh = document.getElementById('maxFormantHz');
     var timeout = null;
     mfh.value = worm.maxFormantHz;
     mfh.addEventListener('change', function(){
       worm.maxFormantHz = mfh.value;
       if(timeout) { cancelAnimationFrame(timeout); }
       
       timeout = requestAnimationFrame(function(){
         cancelAnimationFrame(timeout);
         worm.draw.drawAxes();
       });
     });
    })();
  </script>
</body>
</html>
